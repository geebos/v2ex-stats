## 1. 需求概述

实现 v2ex 年终总结功能，对用户近一年的铜币消耗和获取记录进行聚合分析，生成可视化的年度总结报告。报告涵盖用户在 v2ex 上的各类活动数据，包括发帖、回复、感谢、登录等行为的统计分析，帮助用户全面了解自己在 v2ex 社区一年的活动轨迹。

## 2. 功能点拆分与依赖

| 功能点序号 | 功能点名称 | 功能点描述 | 前置依赖 |
|------------|------------|------------|----------|
| 1 | 数据时间范围筛选 | 支持筛选近一年的铜币记录数据，可配置起止时间范围 | 无 |
| 2 | 行为数据统计 | 统计各类行为数据：回复、发帖、登录、感谢、收到感谢、邀请码与充值等行为的次数、时间分布、铜币消耗/获取等指标 | 1 |
| 3 | 铜币收支总览 | 汇总展示铜币的总收入、总支出、净变化，以及收支占比分析 | 2 |
| 4 | 活动时间热力图 | 按小时和星期维度展示用户活动的时间分布热力图 | 2 |
| 5 | 称号系统 | 根据各类行为的次数、时间、频率等指标，为用户生成活泼有趣的称号标签 | 2 |
| 6 | 入口按钮与弹窗 | 在 v2ex 网站首页个人信息卡片下方添加"查看你的 2025 年终总结"按钮，点击后弹出手机屏幕效果的幻灯片展示 | 2 |
| 7 | 可视化报告生成 | 以幻灯片形式展示各项统计数据，每页展示一项统计并配置动画，最后一页展示所有称号，支持单页导出为图片 | 3, 4, 5, 6 |

## 3. 详细功能说明

### 3.1 数据时间范围筛选
- 默认统计最近一年（365天）的数据
- 支持自定义起止日期
- 对历史数据进行查询和聚合

### 3.2 行为数据统计
统一统计各类行为数据，包括以下子模块：

#### 3.2.1 回复行为统计
- **统计指标**：
  - 回复总次数
  - 消耗铜币总量
  - 平均每次回复消耗的铜币
- **时间分布**：
  - 按月份统计回复趋势
  - 按星期几统计活跃度
  - 按小时统计回复高峰时段
- **称号系统**：
  - **回复次数称号**：
    - <10 次：潜水观察员
    - 10-50 次：偶尔冒泡
    - 50-200 次：活跃回复者
    - 200+ 次：话痨本痨
  - **回复时间称号**（根据最活跃时段）：
    - 早上（6-9点）：晨间思考家
    - 中午（11-14点）：午休键盘侠
    - 下午（14-18点）：午后评论员
    - 晚上（19-23点）：夜间评论员
    - 深夜（23-6点）：夜猫子回复家

#### 3.2.2 发帖行为统计
- **统计指标**：
  - 发帖总次数
  - 消耗铜币总量
  - 平均每次发帖消耗的铜币
- **时间分布**：
  - 按月份统计发帖趋势
  - 发帖最活跃的时间段
- **称号系统**：
  - **发帖次数称号**：
    - <5 次：低调发帖人
    - 5-20 次：内容创作者
    - 20-50 次：高产作者
    - 50+ 次：话题制造机
  - **发帖时间称号**（根据最活跃时段）：
    - 早上（6-9点）：晨间分享家
    - 中午（11-14点）：午间话题王
    - 下午（14-18点）：午后发帖人
    - 晚上（19-23点）：夜间发帖人
    - 深夜（23-6点）：深夜灵感家

#### 3.2.3 登录行为统计
- **统计指标**：
  - 登录总次数
  - 通过登录获取的铜币总量
  - 平均每次登录获得的铜币
- **时间分布**：
  - 连续登录天数统计
  - 登录时间分布
- **称号系统**：
  - **登录次数称号**：
    - <30 次：默默无闻
    - 30-100 次：小有名气
    - 100-200 次：摸鱼专家
    - 200+ 次：V2EX 铁粉
  - **登录时间称号**（根据最活跃时段）：
    - 早上（6-9点）：早起晨读
    - 中午（11-14点）：下饭神器
    - 下午（14-18点）：午后时光
    - 晚上（19-23点）：睡前读物
    - 深夜（23-6点）：夜猫子
  - **连续登录称号**：
    - <7 天：随性登录
    - 7-30 天：坚持打卡
    - 30-100 天：签到达人
    - 100+ 天：连续登录王

#### 3.2.4 感谢行为统计
- **统计指标**：
  - 感谢他人总次数
  - 消耗铜币总量
  - 平均每次感谢消耗的铜币
- **行为分析**：
  - 最常感谢的用户（Top 5）
  - 感谢行为的时间分布
- **称号系统**：
  - **感谢次数称号**：
    - <5 次：含蓄感谢者
    - 5-20 次：温暖感谢者
    - 20-50 次：感谢达人
    - 50+ 次：感谢狂魔
  - **感谢对象称号**（根据感谢对象集中度）：
    - 感谢对象集中：专一感谢者
    - 感谢对象分散：博爱感谢者

#### 3.2.5 收到感谢统计
- **统计指标**：
  - 收到感谢总次数
  - 获得铜币总量
  - 平均每次获得的铜币
- **内容分析**：
  - 收到感谢最多的帖子（Top 5，包含标题、链接、感谢次数）
  - 收到感谢最多的评论（Top 5，包含内容预览、所在帖子、感谢次数）
- **称号系统**：
  - **收到感谢次数称号**：
    - <10 次：低调受欢迎
    - 10-50 次：小有名气
    - 50-100 次：社区红人
    - 100+ 次：感谢收割机
  - **感谢来源称号**（根据感谢来源分布）：
    - 主要来自帖子：帖子感谢王
    - 主要来自评论：评论感谢王
    - 帖子评论均衡：全面感谢王

#### 3.2.6 邀请码与充值统计
- 生成邀请码的次数和消耗铜币
- 充值记录和充值金额统计
- 充值与消耗的对比分析

### 3.3 铜币收支总览
- **收入分析**：
  - 登录获得的铜币
  - 收到感谢获得的铜币
  - 其他收入来源
  - 各类收入占比
- **支出分析**：
  - 发帖消耗的铜币
  - 回复消耗的铜币
  - 感谢他人消耗的铜币
  - 其他支出
  - 各类支出占比
- **净变化**：年度铜币余额变化趋势
- **称号系统**：
  - **铜币净增长称号**：
    - <100 铜币：稳健理财
    - 100-500 铜币：铜币积累者
    - 500-1000 铜币：铜币大户
    - 1000+ 铜币：铜币富翁
  - **支出占比称号**（根据支出占收入比例）：
    - <30%：节俭达人
    - 30-70%：适度消费
    - 70-100%：挥金如土
    - >100%：入不敷出

### 3.4 活动时间热力图
- 按星期和小时展示活动热力图（7x24 矩阵）
- 颜色深度表示活动频率
- 标注最活跃的时间段

### 3.5 称号系统
- **称号生成规则**：
  - 根据各类行为的次数、时间、频率等指标自动生成称号
  - 每个行为类别可生成多个称号（次数称号、时间称号等）
  - 称号展示优先级：次数称号 > 时间称号 > 其他特殊称号
- **称号展示**：
  - 在报告页面显著位置展示用户获得的称号徽章
  - 支持展示多个称号，按重要性排序
  - 称号样式：活泼有趣的标签设计，支持暗黑模式
- **称号分类**：
  - 登录类称号：登录次数、登录时间、连续登录
  - 内容类称号：发帖次数、发帖时间、回复次数、回复时间
  - 互动类称号：感谢次数、收到感谢次数、感谢来源
  - 财富类称号：铜币净增长、支出占比

### 3.6 入口按钮与弹窗
- **入口按钮位置**：
  - 在 v2ex 网站首页个人信息卡片下方添加按钮
  - 按钮文案："查看你的 2025 年终总结"
  - 按钮样式：醒目但不突兀，符合 v2ex 设计风格
- **按钮底部提示**：
  - 显示 "from V2EX Stats" 文字提示
  - 提供"不再显示"超链接样式文本
  - 点击"不再显示"后，按钮和提示不再显示（记录到本地存储）
- **弹窗交互**：
  - 点击按钮后，页面弹出全屏或大尺寸弹窗
  - 弹窗背景：半透明遮罩层
  - 弹窗内容：手机屏幕效果的幻灯片容器
  - 支持点击遮罩层或关闭按钮关闭弹窗

### 3.7 可视化报告生成
- **幻灯片展示形式**：
  - 采用手机屏幕效果设计（竖屏比例，如 375x667 或类似比例）
  - 每页幻灯片展示一项统计数据
  - 幻灯片切换支持左右滑动或点击切换
  - 显示当前页数和总页数指示器
- **幻灯片页面结构**（按顺序）：
  1. **封面页**：年度总结标题、年份、用户信息
  2. **登录行为统计页**：登录次数、登录时间分布、相关称号
  3. **回复行为统计页**：回复次数、回复时间分布、相关称号
  4. **发帖行为统计页**：发帖次数、发帖时间分布、相关称号
  5. **感谢行为统计页**：感谢次数、感谢对象分析、相关称号
  6. **收到感谢统计页**：收到感谢次数、热门内容排行、相关称号
  7. **铜币收支总览页**：收支对比图表、净变化趋势、相关称号
  8. **活动时间热力图页**：7x24 热力图展示
  9. **称号汇总页**：展示用户获得的所有称号徽章
- **动画效果**：
  - 每页幻灯片进入时配置入场动画（如淡入、滑入、数字递增等）
  - 关键数据采用数字递增动画
  - 图表采用渐显或绘制动画
  - 称号徽章采用弹出或闪烁动画
- **单页导出功能**：
  - 每页幻灯片右下角显示下载图标按钮
  - 点击下载图标可将当前页导出为图片
  - 支持复制当前页图片到剪贴板
  - 导出图片分辨率：高清（建议 2x 或 3x 倍率）

## 4. 技术实现要点

### 4.1 数据聚合
- 从 storage 中读取铜币历史记录
- 按交易类型进行分类聚合
- 缓存聚合结果以提升性能

### 4.2 图表渲染
- 使用现有的图表组件（如 ActivityChart、BalanceChart）
- 新增热力图组件
- 统一图表样式和交互体验
- 适配手机屏幕尺寸的图表展示

### 4.3 入口按钮注入
- 通过 content script 在 v2ex 首页注入按钮
- 识别个人信息卡片位置并插入按钮元素
- 监听"不再显示"点击事件，保存到本地存储
- 根据存储状态控制按钮和提示的显示/隐藏

### 4.4 幻灯片实现
- 使用幻灯片组件库（如 Swiper、Embla 等）或自研实现
- 实现手机屏幕效果的容器样式（圆角、阴影、状态栏等）
- 实现页面切换动画和过渡效果
- 实现数字递增动画（使用动画库如 framer-motion、GSAP 等）
- 实现图表绘制动画

### 4.5 图片导出功能
- 使用 html2canvas 或类似库将 DOM 转换为图片
- 处理高清图片导出（2x/3x 倍率）
- 实现复制到剪贴板功能（使用 Clipboard API）
- 优化导出性能，避免内存溢出

### 4.6 性能优化
- 大数据量时采用分页或虚拟滚动
- 异步加载各个统计模块
- 缓存已计算的统计结果
- 幻灯片懒加载：只渲染当前页和相邻页
- 图片导出时优化渲染性能

### 4.7 用户体验
- 添加加载动画和骨架屏
- 支持暗黑模式
- 响应式布局适配不同屏幕
- 幻灯片切换流畅，无明显卡顿
- 导出图片时显示进度提示

## 5. 验收标准

- [ ] 能够正确筛选近一年的数据记录
- [ ] 各类行为统计数据准确无误
- [ ] 时间分布图表展示清晰
- [ ] 收到感谢最多的帖子/评论排行正确
- [ ] 铜币收支总览计算准确
- [ ] 活动时间热力图正确反映用户活跃时段
- [ ] 称号系统能够根据指标正确生成称号
- [ ] 称号展示美观，符合活泼有趣的风格
- [ ] 入口按钮正确显示在个人信息卡片下方
- [ ] "不再显示"功能正常工作，按钮和提示能够隐藏
- [ ] 弹窗能够正常打开和关闭
- [ ] 幻灯片展示手机屏幕效果，样式美观
- [ ] 每页幻灯片动画流畅自然
- [ ] 幻灯片切换交互流畅，支持滑动和点击切换
- [ ] 单页导出功能正常，导出的图片清晰完整
- [ ] 复制到剪贴板功能正常工作
- [ ] 大数据量场景下性能良好，无明显卡顿
